#include <mega328p.h>
#include <io.h>
#include <delay.h>
#include <font.h>

// Declare your global variables here
void SPI_MasterInit(void);
void SPI_Send(unsigned char data);
void Write(unsigned char add1, unsigned char data1,
                 unsigned char add2, unsigned char data2,
                 unsigned char add3, unsigned char data3,
                 unsigned char add4, unsigned char data4,
                 unsigned char add5, unsigned char data5,
                 unsigned char add6, unsigned char data6,
                 unsigned char add7, unsigned char data7,
                 unsigned char add8, unsigned char data8
                );
void Max7219_init(void);
void MAX7219_clear(void);
void Show(int char_index, int matrix_num);
void UpdateDisplay();
void ClearBuffer(void);
void ScrollMessage(char* str);
void ShiftLeft(unsigned char new_column[8]);
unsigned char GetMatrixByte(unsigned char row, unsigned char start_col); 
 

unsigned char scroll_buffer[8][64];
void ScrollBlank(int count); 

void main(void)
{
// Declare your local variables here

SPI_MasterInit();   
Max7219_init();     
MAX7219_clear();
ClearBuffer();

while (1)
      {
          
    //Show(4, 0); 
    //Show(17, 1); 
    //Show(5, 2); 
   // Show(0, 3);  
    //Show(13, 4)
     
    ScrollMessage("Ey AmirMehdi Kos Mamanet");
    ScrollBlank(64);
    delay_ms(100);   
      
      }
}


/*
void select_row(int num){

    //set rows to 0 each round
    PORTB &= ~((1<<0) | (1<<1) | (1<<6) | (1<<7)); 
    
    PORTD &= ~((1<<5) | (1<<7) | (1<<4) | (1<<3));
    
    
    switch(num){
        case 0: 
            PORTD |= (1<<5); 
            break;
        case 1:
            PORTD |= (1<<7); 
            break;
       
        case 2:
            PORTB |= (1<<0); 
            break;
        
        case 3: 
            PORTB |= (1<<1); 
            break;
 
        case 4:
            PORTB |= (1<<6); 
            break;  
        case 5:
            PORTD |= (1<<4); 
            break;  
        case 6:
            PORTD |= (1<<3); 
            break;
        case 7:
            PORTB |= (1<<7); 
            break;          
    }

}


void set_columns(unsigned char data){

    if (data & (1<<0)) { 
        // row is 1 so column should be 0 to have current
        PORTC &= ~(1<<2); 
    } else {
        // we want led off
        PORTC |= (1<<2);
    }
    
    if (data & (1<<1)) { 
        PORTC &= ~(1<<3); 
    } else {
        PORTC |= (1<<3);
    }
    
    if (data & (1<<2)) { 
        PORTD &= ~(1<<0); 
    } else {
        PORTD |= (1<<0);
    }
    
    if (data & (1<<3)) { 
        PORTD &= ~(1<<1); 
    } else {
        PORTD |= (1<<1);
    }
    
    if (data & (1<<4)) { 
        PORTD &= ~(1<<2); 
    } else {
        PORTD |= (1<<2);
    } 
    
    if (data & (1<<5)) { 
        PORTB &= ~(1<<2); 
    } else {
        PORTB |= (1<<2);
    }
    
    if (data & (1<<6)) { 
        PORTB &= ~(1<<3); 
    } else {
        PORTB |= (1<<3);
    }
    
    if (data & (1<<7)) { 
        PORTB &= ~(1<<4); 
    } else {
        PORTB |= (1<<4);
    }

}
   */
   

void Write(unsigned char add1, unsigned char data1,
                 unsigned char add2, unsigned char data2,
                 unsigned char add3, unsigned char data3,
                 unsigned char add4, unsigned char data4,
                 unsigned char add5, unsigned char data5,
                 unsigned char add6, unsigned char data6,
                 unsigned char add7, unsigned char data7,
                 unsigned char add8, unsigned char data8
                )
{
    //Load = 0
    PORTB &= ~(1 << PORTB2);
     
    delay_us(1);
    
    //send address and data for each matrix | same data
    SPI_Send(add8);  SPI_Send(data8); 
    SPI_Send(add7);  SPI_Send(data7); 
    SPI_Send(add6);  SPI_Send(data6); 
    SPI_Send(add5);  SPI_Send(data5); 
    SPI_Send(add4);  SPI_Send(data4); 
    SPI_Send(add3);  SPI_Send(data3); 
    SPI_Send(add2);  SPI_Send(data2); 
    SPI_Send(add1);  SPI_Send(data1);    

    
    delay_us(1);
    
     
    //Load=1
    PORTB |= (1 << PORTB2);  
    
    delay_us(1);   
}


void SPI_MasterInit(void){
    // Set MOSI and SCK output
    DDRB |= (1<<DDB2) | (1<<DDB3) | (1<<DDB5);
    /* Enable SPI, Master, set clock rate fck/16 */ 
    SPCR = (1<<SPE) | (1<<MSTR) | (1<<SPR1) | (1<<SPR0);
    // make LOAD high to make ICs wait
    PORTB |= (1<<PORTB2);
    delay_ms(100); 
} 


void SPI_Send(unsigned char data){

    SPDR = data; 
    while(!(SPSR & (1 << SPIF)));

}


void Max7219_init(){

    Write(0x0C, 0x00,0x0C, 0x00,0x0C, 0x00,0x0C, 0x00,0x0C, 0x00,0x0C, 0x00,0x0C, 0x00,0x0C, 0x00); //shutdown
    delay_ms(50);  
    
    Write(0x0F, 0x00,0x0F, 0x00,0x0F, 0x00,0x0F, 0x00,0x0F, 0x00,0x0F, 0x00,0x0F, 0x00,0x0F, 0x00); //  (Display Test Off) 
    Write(0x09, 0x00,0x09, 0x00,0x09, 0x00,0x09, 0x00,0x09, 0x00,0x09, 0x00,0x09, 0x00,0x09, 0x00); //  (No Decode for LED Matrix)
    Write(0x0B, 0x07,0x0B, 0x07,0x0B, 0x07,0x0B, 0x07,0x0B, 0x07,0x0B, 0x07,0x0B, 0x07,0x0B, 0x07); //  (Scan Limit)
    Write(0x0A, 0x0F,0x0A, 0x0F,0x0A, 0x0F,0x0A, 0x0F,0x0A, 0x0F,0x0A, 0x0F,0x0A, 0x0F,0x0A, 0x0F);   //Intenstity
    
    Write(0x0C, 0x01,0x0C, 0x01,0x0C, 0x01,0x0C, 0x01,0x0C, 0x01,0x0C, 0x01,0x0C, 0x01,0x0C, 0x01); //wake up      
    delay_ms(50);   
}

void MAX7219_clear(){

    unsigned char row;
    
    for (row = 1; row <= 8; row++) {
        Write(row, 0x00,row, 0x00,row, 0x00,row, 0x00,row, 0x00,row, 0x00,row, 0x00,row, 0x00);  // set all rows to 0
        delay_ms(10);
    }
}

//show dislpay matrix values
void UpdateDisplay() {
    unsigned char r;
    for (r = 1; r <= 8; r++) {     
        Write(
            r, GetMatrixByte(r-1, 0),  
            r, GetMatrixByte(r-1, 8),  
            r, GetMatrixByte(r-1, 16), 
            r, GetMatrixByte(r-1, 24),
            r, GetMatrixByte(r-1, 32),
            r, GetMatrixByte(r-1, 40),
            r, GetMatrixByte(r-1, 48),
            r, GetMatrixByte(r-1, 56)
        );
    }
}


unsigned char GetMatrixByte(unsigned char row, unsigned char start_col) {
    unsigned char b, result = 0;
    for (b = 0; b < 8; b++) {
        if (scroll_buffer[row][start_col + b] == 0x01) {
            result |= (1 << (7 - b)); 
        }
    }
    return result;
}

/*
//display matrix initialization
void Show(int char_index, int matrix_num){
    unsigned char s, b;
    unsigned char original_byte;
    unsigned char mirrored_byte;

    for(s=0; s<8; s++){
        original_byte = font_alphabet[char_index][s];
        mirrored_byte = 0;

      
        for(b=0; b<8; b++) {
            if(original_byte & (1 << b)) {
                mirrored_byte |= (1 << (7 - b));
            }
        }
        
       
        display_matrix[s][matrix_num] = mirrored_byte;
    }
}
*/

void ClearBuffer(void) {
   unsigned char r, c;

    
    for (r = 0; r < 8; r++) {
        for (c = 0; c < 64; c++) {
            scroll_buffer[r][c] = 0x00;
        }
    }
    
    UpdateDisplay();
}

void ScrollBlank(int count) {
    int i;
    unsigned char row;
    unsigned char blank_col[8] = {0,0,0,0,0,0,0,0};
    
    for(i = 0; i < count; i++) {
        ShiftLeft(blank_col);
        UpdateDisplay();
        delay_ms(10);
    }
}


void ShiftLeft(unsigned char new_column[8]) {
    unsigned char r, c;
    
    for (r = 0; r < 8; r++) {
        // shit all columns to left
        for (c = 0; c < 63; c++) {
            scroll_buffer[r][c] = scroll_buffer[r][c+1];
        }
             
       
        if (new_column[r] == 1) {
            // max7219 only accepts 16 bits
            scroll_buffer[r][63] = 0x01;
        } else {
            scroll_buffer[r][63] = 0x00;
        }    
        
        
    }
}



void ScrollMessage(char* str) {
    int i, char_idx;
    unsigned char col, row, type; 
    unsigned char current_col_data[8];
    unsigned char row_data;

    for (i = 0; str[i] != '\0'; i++) {
        char c = str[i];
        
  
        if (c >= 'A' && c <= 'Z') {
            type = 0;
            char_idx = c - 'A';
        } 
        else if (c >= 'a' && c <= 'z') {
            type = 0; 
            char_idx = (c - 'a') + 27; 
        } 
        else if (c == ' ') {
            type = 0; 
            char_idx = 26; 
        }
        else if (c >= '0' && c <= '9') {
            type = 1;
            char_idx = (c == '0') ? 9 : (c - '1');
        }
        else {
            type = 0; 
            char_idx = 26;
        }

      
        for (col = 0; col < 8; col++) {
            for (row = 0; row < 8; row++) {
                
              
                if (type == 0) {
                    row_data = font_alphabet[char_idx][row];
                } else {
                    row_data = font_numbers[char_idx][row];
                }
                
             
                if (row_data & (1 << col)) {
                    current_col_data[row] = 1; 
                } else {
                    current_col_data[row] = 0;
                }
            }

        
            ShiftLeft(current_col_data);
            UpdateDisplay();
            delay_ms(10); 
        }
        
     
        for(row = 0; row < 8; row++) current_col_data[row] = 0;
        ShiftLeft(current_col_data);
        UpdateDisplay();
        delay_ms(10);
    }
}


